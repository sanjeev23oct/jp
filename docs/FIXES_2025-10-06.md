# Bug Fixes - October 6, 2025

## Issues Fixed

### 1. âœ… Undo/Redo Preview Disappearing
**Problem:** When undo/redo was executed, the preview would disappear and nothing would happen.

**Root Cause:** The `addCommand` function in `useHistoryStore.ts` was calling `command.execute()` which would re-apply the snapshot, but the code had already been updated. This caused the state to be applied twice, leading to inconsistencies.

**Fix:** Removed the `command.execute()` call from `addCommand`. Commands are now only stored for undo/redo, not executed when added (since the changes have already been applied).

**Files Modified:**
- `frontend/src/store/useHistoryStore.ts`

---

### 2. âœ… Visual Editing Screen Flicker
**Problem:** When changing text in visual edit mode, the screen would flicker.

**Root Cause:** Text content changes were triggering HTML updates via `updateHtml()`, which would reload the iframe and cause flickering.

**Fix:** Modified `updateElement` in `useVisualEditor.ts` to apply all changes (text, className, id, styles) directly to the DOM element without triggering HTML updates. Changes are only saved to the code when the user clicks "Save Changes to Code" button.

**Files Modified:**
- `frontend/src/hooks/useVisualEditor.ts`

---

### 3. âœ… Color Changes Not Reflected
**Problem:** When changing colors in visual edit mode, the changes weren't visible.

**Root Cause:** Same as issue #2 - the changes were being applied but then the iframe was being reloaded, losing the inline style changes.

**Fix:** Same as issue #2 - all style changes are now applied as inline styles directly to the element and persist until "Save Changes to Code" is clicked.

**Files Modified:**
- `frontend/src/hooks/useVisualEditor.ts`

---

### 4. âœ… Todo App Add Button Not Working
**Problem:** When generating a todo app, clicking the "Add" button wouldn't add new tasks to the list. Data wasn't persisting to localStorage.

**Fixes Applied:**

#### A. Enhanced Agent Mode Prompt
Updated the system prompt to be more explicit about:
- ALL buttons MUST have working click handlers (NO DUMMY BUTTONS)
- ALL forms MUST have working submit handlers with preventDefault()
- Proper initialization with DOMContentLoaded
- localStorage/IndexedDB implementation for data persistence
- Pre-populated sample data (5-10 items)
- Real-time UI updates when data changes

#### B. Added Form Support to Iframe
Added `allow-forms` to the iframe sandbox attribute to ensure form submissions work properly.

#### C. Emphasized Functional Requirements
Added explicit verification requirements:
- When user clicks "Add" button, item MUST appear in list immediately
- When page refreshes, all data MUST still be there
- Use localStorage.setItem() and localStorage.getItem() for simple data storage

**Files Modified:**
- `backend/src/llm/prompts/agent-mode.ts`
- `frontend/src/components/editor/LivePreview.tsx`

---

## Testing Instructions

### Test Undo/Redo:
1. Generate a prototype (e.g., "create a login form")
2. Make some visual edits or surgical edits
3. Click the undo button (â†¶) or press Ctrl+Z
4. Verify the preview shows the previous state
5. Click the redo button (â†·) or press Ctrl+Y
6. Verify the preview shows the next state
7. Open the history timeline (ðŸ“œ button) and click on any history item
8. Verify you can jump to that point in history

### Test Visual Editing:
1. Generate a prototype
2. Click "ðŸŽ¨ Enable Visual Edit"
3. Click on any text element
4. Change the text in the property panel
5. Verify: No screen flicker, text updates smoothly
6. Change the color of the element
7. Verify: Color changes are visible immediately
8. Click "ðŸ’¾ Save Changes to Code"
9. Verify: Changes are persisted

### Test Todo App Functionality:
1. Generate a todo app: "create a todo list app"
2. Verify: App loads with 5-10 sample todos already in the list
3. Type a new todo in the input field
4. Click the "Add" button
5. Verify: New todo appears in the list immediately
6. Refresh the page (F5)
7. Verify: All todos (including the one you added) are still there
8. Mark a todo as complete
9. Verify: UI updates immediately
10. Refresh the page
11. Verify: Completed status is preserved

---

## Technical Details

### Undo/Redo Architecture
The undo/redo system uses the Command Pattern:
- Each action (visual edit, surgical edit, agent generation) creates a Command object
- Commands store before/after snapshots of the code
- Commands are added to the undo stack (but NOT executed)
- Undo pops from undo stack, executes undo(), pushes to redo stack
- Redo pops from redo stack, executes redo(), pushes to undo stack

### Visual Editing Architecture
Visual editing now works in two phases:
1. **Edit Phase**: Changes are applied directly to the iframe DOM as inline styles
   - No HTML updates, no iframe reloads
   - Smooth, flicker-free experience
2. **Save Phase**: When user clicks "Save Changes to Code"
   - Extract the updated HTML with inline styles
   - Update the editor store
   - Add to history for undo/redo

### Agent Mode Improvements
The agent mode prompt now emphasizes:
- Functional prototypes over dummy/placeholder code
- localStorage for simple data persistence
- IndexedDB for complex data structures
- Proper event listener initialization
- Pre-populated sample data for demos
- Real-time UI updates

---

## Known Limitations

1. **Visual Editing**: Changes are stored as inline styles. For production, these should be extracted to CSS classes.
2. **Undo/Redo**: Limited to 50 entries to maintain performance.
3. **Agent Mode**: Quality depends on LLM's ability to generate functional code. May require regeneration if code doesn't work as expected.

---

## Next Steps

Consider implementing:
1. Diff preview before applying surgical edits (Task 6-9)
2. Edit templates for common patterns (Task 10-15)
3. Component library with drag-and-drop (Task 16-23)
4. Better error handling and user feedback
5. Code quality validation before saving
